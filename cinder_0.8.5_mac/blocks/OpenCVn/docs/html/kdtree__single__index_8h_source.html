<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta content="text/html; charset=ISO-8859-1" http-equiv="content-type"><title>Cinder</title>
		<link rel="stylesheet" href="cinder_doxygen.css" type="text/css" media="screen" />
	</head>
<body>	
<div class="wrapper">
	<div id="header">
		<h1><a href="http://libcinder.org">Cinder</a></h1>
	</div>

<!-- Generated by Doxygen 1.8.0 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">include/opencv2/flann/kdtree_single_index.h</div>  </div>
</div><!--header-->
<div class="contents">
<a href="kdtree__single__index_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/***********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> * Software License Agreement (BSD License)</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright 2008-2009  Marius Muja (mariusm@cs.ubc.ca). All rights reserved.</span>
<a name="l00005"></a>00005 <span class="comment"> * Copyright 2008-2009  David G. Lowe (lowe@cs.ubc.ca). All rights reserved.</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * THE BSD LICENSE</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00010"></a>00010 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00011"></a>00011 <span class="comment"> * are met:</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00014"></a>00014 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00015"></a>00015 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00016"></a>00016 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00017"></a>00017 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS&#39;&#39; AND ANY EXPRESS OR</span>
<a name="l00020"></a>00020 <span class="comment"> * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</span>
<a name="l00021"></a>00021 <span class="comment"> * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.</span>
<a name="l00022"></a>00022 <span class="comment"> * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00023"></a>00023 <span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
<a name="l00024"></a>00024 <span class="comment"> * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<a name="l00025"></a>00025 <span class="comment"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<a name="l00026"></a>00026 <span class="comment"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00027"></a>00027 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<a name="l00028"></a>00028 <span class="comment"> * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00029"></a>00029 <span class="comment"> *************************************************************************/</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#ifndef OPENCV_FLANN_KDTREE_SINGLE_INDEX_H_</span>
<a name="l00032"></a>00032 <span class="preprocessor"></span><span class="preprocessor">#define OPENCV_FLANN_KDTREE_SINGLE_INDEX_H_</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;map&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;cassert&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;cstring&gt;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="general_8h.html">general.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="nn__index_8h.html">nn_index.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;matrix.h&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="result__set_8h.html">result_set.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="heap_8h.html">heap.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="allocator_8h.html">allocator.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="random_8h.html">random.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="saving_8h.html">saving.h</a>&quot;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="keyword">namespace </span>cvflann
<a name="l00049"></a>00049 {
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="structcvflann_1_1_k_d_tree_single_index_params.html">00051</a> <span class="keyword">struct </span><a class="code" href="structcvflann_1_1_k_d_tree_single_index_params.html">KDTreeSingleIndexParams</a> : <span class="keyword">public</span> <a class="code" href="namespacecvflann.html#a742b4c7076c21012054af74a9ee48289">IndexParams</a>
<a name="l00052"></a>00052 {
<a name="l00053"></a><a class="code" href="structcvflann_1_1_k_d_tree_single_index_params.html#a8fc0014175e94ebef3cb811bc9219e1f">00053</a>     <a class="code" href="structcvflann_1_1_k_d_tree_single_index_params.html#a8fc0014175e94ebef3cb811bc9219e1f">KDTreeSingleIndexParams</a>(<span class="keywordtype">int</span> leaf_max_size = 10, <span class="keywordtype">bool</span> reorder = <span class="keyword">true</span>, <span class="keywordtype">int</span> dim = -1)
<a name="l00054"></a>00054     {
<a name="l00055"></a>00055         (*this)[<span class="stringliteral">&quot;algorithm&quot;</span>] = <a class="code" href="namespacecvflann.html#a4e3e6c98d774ea77fd7f0045c9bc7817a0fda72a4e7d3403cb4f5246d231957ed">FLANN_INDEX_KDTREE_SINGLE</a>;
<a name="l00056"></a>00056         (*this)[<span class="stringliteral">&quot;leaf_max_size&quot;</span>] = leaf_max_size;
<a name="l00057"></a>00057         (*this)[<span class="stringliteral">&quot;reorder&quot;</span>] = reorder;
<a name="l00058"></a>00058         (*this)[<span class="stringliteral">&quot;dim&quot;</span>] = dim;
<a name="l00059"></a>00059     }
<a name="l00060"></a>00060 };
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 
<a name="l00069"></a>00069 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Distance&gt;
<a name="l00070"></a><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html">00070</a> <span class="keyword">class </span><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html">KDTreeSingleIndex</a> : <span class="keyword">public</span> <a class="code" href="classcvflann_1_1_n_n_index.html">NNIndex</a>&lt;Distance&gt;
<a name="l00071"></a>00071 {
<a name="l00072"></a>00072 <span class="keyword">public</span>:
<a name="l00073"></a><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">00073</a>     <span class="keyword">typedef</span> <span class="keyword">typename</span> Distance::ElementType <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">ElementType</a>;
<a name="l00074"></a><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">00074</a>     <span class="keyword">typedef</span> <span class="keyword">typename</span> Distance::ResultType <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a>;
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 
<a name="l00084"></a><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a08512e3697cf135110f190b376e40cd3">00084</a>     <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a08512e3697cf135110f190b376e40cd3">KDTreeSingleIndex</a>(<span class="keyword">const</span> <a class="code" href="classcvflann_1_1_matrix.html">Matrix&lt;ElementType&gt;</a>&amp; inputData, <span class="keyword">const</span> <a class="code" href="namespacecvflann.html#a742b4c7076c21012054af74a9ee48289">IndexParams</a>&amp; <a class="code" href="compat_8hpp.html#a0480a03ecc41b20cde376602531d9270">params</a> = <a class="code" href="structcvflann_1_1_k_d_tree_single_index_params.html">KDTreeSingleIndexParams</a>(),
<a name="l00085"></a>00085                       Distance <a class="code" href="legacy_8hpp.html#a6f364afbe132c4ecfea48bde1b0618ba">d</a> = Distance() ) :
<a name="l00086"></a>00086         dataset_(inputData), index_params_(<a class="code" href="compat_8hpp.html#a0480a03ecc41b20cde376602531d9270">params</a>), distance_(<a class="code" href="legacy_8hpp.html#a6f364afbe132c4ecfea48bde1b0618ba">d</a>)
<a name="l00087"></a>00087     {
<a name="l00088"></a>00088         size_ = dataset_.<a class="code" href="classcvflann_1_1_matrix.html#aff6ee6abf050b1848fca59654c5669bc">rows</a>;
<a name="l00089"></a>00089         dim_ = dataset_.<a class="code" href="classcvflann_1_1_matrix.html#a37b28f9c0d87c84cf396dcbe90fae71f">cols</a>;
<a name="l00090"></a>00090         <span class="keywordtype">int</span> dim_param = <a class="code" href="namespacecvflann.html#a6ea20e8aad20212544cb42368c1e5b5f">get_param</a>(<a class="code" href="compat_8hpp.html#a0480a03ecc41b20cde376602531d9270">params</a>,<span class="stringliteral">&quot;dim&quot;</span>,-1);
<a name="l00091"></a>00091         <span class="keywordflow">if</span> (dim_param&gt;0) dim_ = dim_param;
<a name="l00092"></a>00092         leaf_max_size_ = <a class="code" href="namespacecvflann.html#a6ea20e8aad20212544cb42368c1e5b5f">get_param</a>(<a class="code" href="compat_8hpp.html#a0480a03ecc41b20cde376602531d9270">params</a>,<span class="stringliteral">&quot;leaf_max_size&quot;</span>,10);
<a name="l00093"></a>00093         reorder_ = <a class="code" href="namespacecvflann.html#a6ea20e8aad20212544cb42368c1e5b5f">get_param</a>(<a class="code" href="compat_8hpp.html#a0480a03ecc41b20cde376602531d9270">params</a>,<span class="stringliteral">&quot;reorder&quot;</span>,<span class="keyword">true</span>);
<a name="l00094"></a>00094 
<a name="l00095"></a>00095         <span class="comment">// Create a permutable array of indices to the input vectors.</span>
<a name="l00096"></a>00096         vind_.resize(size_);
<a name="l00097"></a>00097         <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; size_; i++) {
<a name="l00098"></a>00098             vind_[i] = (<a class="code" href="namespacecv_1_1gpu_1_1device.html#a75abe072f62e9cbacd4e282107467bbb">int</a>)i;
<a name="l00099"></a>00099         }
<a name="l00100"></a>00100     }
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a08512e3697cf135110f190b376e40cd3">KDTreeSingleIndex</a>(<span class="keyword">const</span> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html">KDTreeSingleIndex</a>&amp;);
<a name="l00103"></a>00103     <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html">KDTreeSingleIndex</a>&amp; <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ad36b97f782f485ae991a01816839073b">operator=</a>(<span class="keyword">const</span> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html">KDTreeSingleIndex</a>&amp;);
<a name="l00104"></a>00104 
<a name="l00108"></a><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a9f4c82ef64eb57eff3d03d0d5c08bac6">00108</a>     <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a9f4c82ef64eb57eff3d03d0d5c08bac6">~KDTreeSingleIndex</a>()
<a name="l00109"></a>00109     {
<a name="l00110"></a>00110         <span class="keywordflow">if</span> (reorder_) <span class="keyword">delete</span>[] data_.<a class="code" href="classcvflann_1_1_matrix.html#a861faba1129cde780d5f0d0fbc568934">data</a>;
<a name="l00111"></a>00111     }
<a name="l00112"></a>00112 
<a name="l00116"></a><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab3f54bfaa6c99b1e5116b35d5f370227">00116</a>     <span class="keywordtype">void</span> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab3f54bfaa6c99b1e5116b35d5f370227">buildIndex</a>()
<a name="l00117"></a>00117     {
<a name="l00118"></a>00118         computeBoundingBox(root_bbox_);
<a name="l00119"></a>00119         root_node_ = divideTree(0, (<span class="keywordtype">int</span>)size_, root_bbox_ );   <span class="comment">// construct the tree</span>
<a name="l00120"></a>00120 
<a name="l00121"></a>00121         <span class="keywordflow">if</span> (reorder_) {
<a name="l00122"></a>00122             <span class="keyword">delete</span>[] data_.<a class="code" href="classcvflann_1_1_matrix.html#a861faba1129cde780d5f0d0fbc568934">data</a>;
<a name="l00123"></a>00123             data_ = <a class="code" href="classcvflann_1_1_matrix.html">cvflann::Matrix&lt;ElementType&gt;</a>(<span class="keyword">new</span> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">ElementType</a>[size_*dim_], size_, dim_);
<a name="l00124"></a>00124             <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;size_; ++i) {
<a name="l00125"></a>00125                 <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j=0; j&lt;dim_; ++j) {
<a name="l00126"></a>00126                     data_[i][j] = dataset_[vind_[i]][j];
<a name="l00127"></a>00127                 }
<a name="l00128"></a>00128             }
<a name="l00129"></a>00129         }
<a name="l00130"></a>00130         <span class="keywordflow">else</span> {
<a name="l00131"></a>00131             data_ = dataset_;
<a name="l00132"></a>00132         }
<a name="l00133"></a>00133     }
<a name="l00134"></a>00134 
<a name="l00135"></a><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a562c049eeaf138b5bc9ead6129ff41e9">00135</a>     <a class="code" href="namespacecvflann.html#a4e3e6c98d774ea77fd7f0045c9bc7817">flann_algorithm_t</a> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a562c049eeaf138b5bc9ead6129ff41e9">getType</a>()<span class="keyword"> const</span>
<a name="l00136"></a>00136 <span class="keyword">    </span>{
<a name="l00137"></a>00137         <span class="keywordflow">return</span> <a class="code" href="namespacecvflann.html#a4e3e6c98d774ea77fd7f0045c9bc7817a0fda72a4e7d3403cb4f5246d231957ed">FLANN_INDEX_KDTREE_SINGLE</a>;
<a name="l00138"></a>00138     }
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 
<a name="l00141"></a><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#adacba07ebbd7ed471f2645b64bb883e5">00141</a>     <span class="keywordtype">void</span> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#adacba07ebbd7ed471f2645b64bb883e5" title="Saves the index to a stream.">saveIndex</a>(FILE* stream)
<a name="l00142"></a>00142     {
<a name="l00143"></a>00143         <a class="code" href="namespacecvflann.html#af21cc31d343e3e1132f34e11094d49a1">save_value</a>(stream, size_);
<a name="l00144"></a>00144         <a class="code" href="namespacecvflann.html#af21cc31d343e3e1132f34e11094d49a1">save_value</a>(stream, dim_);
<a name="l00145"></a>00145         <a class="code" href="namespacecvflann.html#af21cc31d343e3e1132f34e11094d49a1">save_value</a>(stream, root_bbox_);
<a name="l00146"></a>00146         <a class="code" href="namespacecvflann.html#af21cc31d343e3e1132f34e11094d49a1">save_value</a>(stream, reorder_);
<a name="l00147"></a>00147         <a class="code" href="namespacecvflann.html#af21cc31d343e3e1132f34e11094d49a1">save_value</a>(stream, leaf_max_size_);
<a name="l00148"></a>00148         <a class="code" href="namespacecvflann.html#af21cc31d343e3e1132f34e11094d49a1">save_value</a>(stream, vind_);
<a name="l00149"></a>00149         <span class="keywordflow">if</span> (reorder_) {
<a name="l00150"></a>00150             <a class="code" href="namespacecvflann.html#af21cc31d343e3e1132f34e11094d49a1">save_value</a>(stream, data_);
<a name="l00151"></a>00151         }
<a name="l00152"></a>00152         save_tree(stream, root_node_);
<a name="l00153"></a>00153     }
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 
<a name="l00156"></a><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab895fb2728fdd040790b8278e18a2fb7">00156</a>     <span class="keywordtype">void</span> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab895fb2728fdd040790b8278e18a2fb7" title="Loads the index from a stream.">loadIndex</a>(FILE* stream)
<a name="l00157"></a>00157     {
<a name="l00158"></a>00158         <a class="code" href="namespacecvflann.html#ac76450e068ff8d95e2e5736141201faf">load_value</a>(stream, size_);
<a name="l00159"></a>00159         <a class="code" href="namespacecvflann.html#ac76450e068ff8d95e2e5736141201faf">load_value</a>(stream, dim_);
<a name="l00160"></a>00160         <a class="code" href="namespacecvflann.html#ac76450e068ff8d95e2e5736141201faf">load_value</a>(stream, root_bbox_);
<a name="l00161"></a>00161         <a class="code" href="namespacecvflann.html#ac76450e068ff8d95e2e5736141201faf">load_value</a>(stream, reorder_);
<a name="l00162"></a>00162         <a class="code" href="namespacecvflann.html#ac76450e068ff8d95e2e5736141201faf">load_value</a>(stream, leaf_max_size_);
<a name="l00163"></a>00163         <a class="code" href="namespacecvflann.html#ac76450e068ff8d95e2e5736141201faf">load_value</a>(stream, vind_);
<a name="l00164"></a>00164         <span class="keywordflow">if</span> (reorder_) {
<a name="l00165"></a>00165             <a class="code" href="namespacecvflann.html#ac76450e068ff8d95e2e5736141201faf">load_value</a>(stream, data_);
<a name="l00166"></a>00166         }
<a name="l00167"></a>00167         <span class="keywordflow">else</span> {
<a name="l00168"></a>00168             data_ = dataset_;
<a name="l00169"></a>00169         }
<a name="l00170"></a>00170         load_tree(stream, root_node_);
<a name="l00171"></a>00171 
<a name="l00172"></a>00172 
<a name="l00173"></a>00173         index_params_[<span class="stringliteral">&quot;algorithm&quot;</span>] = <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a562c049eeaf138b5bc9ead6129ff41e9">getType</a>();
<a name="l00174"></a>00174         index_params_[<span class="stringliteral">&quot;leaf_max_size&quot;</span>] = leaf_max_size_;
<a name="l00175"></a>00175         index_params_[<span class="stringliteral">&quot;reorder&quot;</span>] = reorder_;
<a name="l00176"></a>00176     }
<a name="l00177"></a>00177 
<a name="l00181"></a><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#af9db9baa7fc203e002f1e0e5c7f4e3de">00181</a>     <span class="keywordtype">size_t</span> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#af9db9baa7fc203e002f1e0e5c7f4e3de">size</a>()<span class="keyword"> const</span>
<a name="l00182"></a>00182 <span class="keyword">    </span>{
<a name="l00183"></a>00183         <span class="keywordflow">return</span> size_;
<a name="l00184"></a>00184     }
<a name="l00185"></a>00185 
<a name="l00189"></a><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a4f9c5a8847c6b86b715606635669098e">00189</a>     <span class="keywordtype">size_t</span> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a4f9c5a8847c6b86b715606635669098e">veclen</a>()<span class="keyword"> const</span>
<a name="l00190"></a>00190 <span class="keyword">    </span>{
<a name="l00191"></a>00191         <span class="keywordflow">return</span> dim_;
<a name="l00192"></a>00192     }
<a name="l00193"></a>00193 
<a name="l00198"></a><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#adb37afd1fc827ca1ad640abec4396a75">00198</a>     <span class="keywordtype">int</span> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#adb37afd1fc827ca1ad640abec4396a75">usedMemory</a>()<span class="keyword"> const</span>
<a name="l00199"></a>00199 <span class="keyword">    </span>{
<a name="l00200"></a>00200         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)(pool_.<a class="code" href="classcvflann_1_1_pooled_allocator.html#a6e5510ec11212e0bb1b109b3af09e172">usedMemory</a>+pool_.<a class="code" href="classcvflann_1_1_pooled_allocator.html#af69edd6191138a563f9205d1db7bdd18">wastedMemory</a>+dataset_.<a class="code" href="classcvflann_1_1_matrix.html#aff6ee6abf050b1848fca59654c5669bc">rows</a>*<span class="keyword">sizeof</span>(<a class="code" href="namespacecv_1_1gpu_1_1device.html#a75abe072f62e9cbacd4e282107467bbb">int</a>));  <span class="comment">// pool memory and vind array memory</span>
<a name="l00201"></a>00201     }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 
<a name="l00212"></a><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a5f53f54a2b04a25a370cb7f03a5317df">00212</a>     <span class="keywordtype">void</span> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a5f53f54a2b04a25a370cb7f03a5317df" title="Perform k-nearest neighbor search.">knnSearch</a>(<span class="keyword">const</span> <a class="code" href="classcvflann_1_1_matrix.html">Matrix&lt;ElementType&gt;</a>&amp; queries, <a class="code" href="classcvflann_1_1_matrix.html">Matrix&lt;int&gt;</a>&amp; <a class="code" href="legacy_8hpp.html#a3e3b9b48bcbc7f460efbcfe4399ad24a">indices</a>, <a class="code" href="classcvflann_1_1_matrix.html">Matrix&lt;DistanceType&gt;</a>&amp; dists, <span class="keywordtype">int</span> knn, <span class="keyword">const</span> <a class="code" href="structcvflann_1_1_search_params.html">SearchParams</a>&amp; <a class="code" href="compat_8hpp.html#a0480a03ecc41b20cde376602531d9270">params</a>)
<a name="l00213"></a>00213     {
<a name="l00214"></a>00214         assert(queries.<a class="code" href="classcvflann_1_1_matrix.html#a37b28f9c0d87c84cf396dcbe90fae71f">cols</a> == <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a4f9c5a8847c6b86b715606635669098e">veclen</a>());
<a name="l00215"></a>00215         assert(indices.<a class="code" href="classcvflann_1_1_matrix.html#aff6ee6abf050b1848fca59654c5669bc">rows</a> &gt;= queries.<a class="code" href="classcvflann_1_1_matrix.html#aff6ee6abf050b1848fca59654c5669bc">rows</a>);
<a name="l00216"></a>00216         assert(dists.<a class="code" href="classcvflann_1_1_matrix.html#aff6ee6abf050b1848fca59654c5669bc">rows</a> &gt;= queries.<a class="code" href="classcvflann_1_1_matrix.html#aff6ee6abf050b1848fca59654c5669bc">rows</a>);
<a name="l00217"></a>00217         assert(<span class="keywordtype">int</span>(indices.<a class="code" href="classcvflann_1_1_matrix.html#a37b28f9c0d87c84cf396dcbe90fae71f">cols</a>) &gt;= knn);
<a name="l00218"></a>00218         assert(<span class="keywordtype">int</span>(dists.<a class="code" href="classcvflann_1_1_matrix.html#a37b28f9c0d87c84cf396dcbe90fae71f">cols</a>) &gt;= knn);
<a name="l00219"></a>00219 
<a name="l00220"></a>00220         <a class="code" href="classcvflann_1_1_k_n_n_simple_result_set.html">KNNSimpleResultSet&lt;DistanceType&gt;</a> resultSet(knn);
<a name="l00221"></a>00221         <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; queries.<a class="code" href="classcvflann_1_1_matrix.html#aff6ee6abf050b1848fca59654c5669bc">rows</a>; i++) {
<a name="l00222"></a>00222             resultSet.<a class="code" href="classcvflann_1_1_k_n_n_simple_result_set.html#ad3b74564e2e5dbd947fc2f8d40a2f152">init</a>(indices[i], dists[i]);
<a name="l00223"></a>00223             <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#aedd8818914111a3ef3740ee72c1b8477">findNeighbors</a>(resultSet, queries[i], params);
<a name="l00224"></a>00224         }
<a name="l00225"></a>00225     }
<a name="l00226"></a>00226 
<a name="l00227"></a><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#aee3e3322dd956e234f17146fc220229a">00227</a>     <a class="code" href="namespacecvflann.html#a742b4c7076c21012054af74a9ee48289">IndexParams</a> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#aee3e3322dd956e234f17146fc220229a">getParameters</a>()<span class="keyword"> const</span>
<a name="l00228"></a>00228 <span class="keyword">    </span>{
<a name="l00229"></a>00229         <span class="keywordflow">return</span> index_params_;
<a name="l00230"></a>00230     }
<a name="l00231"></a>00231 
<a name="l00241"></a><a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#aedd8818914111a3ef3740ee72c1b8477">00241</a>     <span class="keywordtype">void</span> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#aedd8818914111a3ef3740ee72c1b8477">findNeighbors</a>(<a class="code" href="classcvflann_1_1_result_set.html">ResultSet&lt;DistanceType&gt;</a>&amp; <a class="code" href="core__c_8h.html#a14871c176a686a03035b5f2bbc72a63f">result</a>, <span class="keyword">const</span> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">ElementType</a>* vec, <span class="keyword">const</span> <a class="code" href="structcvflann_1_1_search_params.html">SearchParams</a>&amp; searchParams)
<a name="l00242"></a>00242     {
<a name="l00243"></a>00243         <span class="keywordtype">float</span> epsError = 1+<a class="code" href="namespacecvflann.html#a6ea20e8aad20212544cb42368c1e5b5f">get_param</a>(searchParams,<span class="stringliteral">&quot;eps&quot;</span>,0.0f);
<a name="l00244"></a>00244 
<a name="l00245"></a>00245         std::vector&lt;DistanceType&gt; dists(dim_,0);
<a name="l00246"></a>00246         <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> distsq = computeInitialDistances(vec, dists);
<a name="l00247"></a>00247         searchLevel(result, vec, root_node_, distsq, dists, epsError);
<a name="l00248"></a>00248     }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 <span class="keyword">private</span>:
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <span class="comment">/*--------------------- Internal Data Structures --------------------------*/</span>
<a name="l00254"></a>00254     <span class="keyword">struct </span>Node
<a name="l00255"></a>00255     {
<a name="l00259"></a>00259         <span class="keywordtype">int</span> left, <a class="code" href="calib3d_8hpp.html#a6b04b878081bf724144b73c75dfd1894">right</a>;
<a name="l00263"></a>00263         <span class="keywordtype">int</span> divfeat;
<a name="l00267"></a>00267         <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> divlow, divhigh;
<a name="l00271"></a>00271         Node* child1, * child2;
<a name="l00272"></a>00272     };
<a name="l00273"></a>00273     <span class="keyword">typedef</span> Node* NodePtr;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275 
<a name="l00276"></a>00276     <span class="keyword">struct </span>Interval
<a name="l00277"></a>00277     {
<a name="l00278"></a>00278         <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> low, high;
<a name="l00279"></a>00279     };
<a name="l00280"></a>00280 
<a name="l00281"></a>00281     <span class="keyword">typedef</span> std::vector&lt;Interval&gt; BoundingBox;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283     <span class="keyword">typedef</span> BranchStruct&lt;NodePtr, DistanceType&gt; BranchSt;
<a name="l00284"></a>00284     <span class="keyword">typedef</span> BranchSt* Branch;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 
<a name="l00288"></a>00288 
<a name="l00289"></a>00289     <span class="keywordtype">void</span> save_tree(FILE* stream, NodePtr tree)
<a name="l00290"></a>00290     {
<a name="l00291"></a>00291         <a class="code" href="namespacecvflann.html#af21cc31d343e3e1132f34e11094d49a1">save_value</a>(stream, *tree);
<a name="l00292"></a>00292         <span class="keywordflow">if</span> (tree-&gt;child1!=NULL) {
<a name="l00293"></a>00293             save_tree(stream, tree-&gt;child1);
<a name="l00294"></a>00294         }
<a name="l00295"></a>00295         <span class="keywordflow">if</span> (tree-&gt;child2!=NULL) {
<a name="l00296"></a>00296             save_tree(stream, tree-&gt;child2);
<a name="l00297"></a>00297         }
<a name="l00298"></a>00298     }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 
<a name="l00301"></a>00301     <span class="keywordtype">void</span> load_tree(FILE* stream, NodePtr&amp; tree)
<a name="l00302"></a>00302     {
<a name="l00303"></a>00303         tree = pool_.<a class="code" href="classcvflann_1_1_pooled_allocator.html#aaf127cab57cd0e0f4d3b335efd8d3a67">allocate</a>&lt;Node&gt;();
<a name="l00304"></a>00304         <a class="code" href="namespacecvflann.html#ac76450e068ff8d95e2e5736141201faf">load_value</a>(stream, *tree);
<a name="l00305"></a>00305         <span class="keywordflow">if</span> (tree-&gt;child1!=NULL) {
<a name="l00306"></a>00306             load_tree(stream, tree-&gt;child1);
<a name="l00307"></a>00307         }
<a name="l00308"></a>00308         <span class="keywordflow">if</span> (tree-&gt;child2!=NULL) {
<a name="l00309"></a>00309             load_tree(stream, tree-&gt;child2);
<a name="l00310"></a>00310         }
<a name="l00311"></a>00311     }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313 
<a name="l00314"></a>00314     <span class="keywordtype">void</span> computeBoundingBox(BoundingBox&amp; bbox)
<a name="l00315"></a>00315     {
<a name="l00316"></a>00316         bbox.resize(dim_);
<a name="l00317"></a>00317         <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;dim_; ++i) {
<a name="l00318"></a>00318             bbox[i].low = (<a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a>)dataset_[0][i];
<a name="l00319"></a>00319             bbox[i].high = (<a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a>)dataset_[0][i];
<a name="l00320"></a>00320         }
<a name="l00321"></a>00321         <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="legacy_8hpp.html#a7be9b6436e5ea72ff5d5a66779b4bd38">k</a>=1; <a class="code" href="legacy_8hpp.html#a7be9b6436e5ea72ff5d5a66779b4bd38">k</a>&lt;dataset_.<a class="code" href="classcvflann_1_1_matrix.html#aff6ee6abf050b1848fca59654c5669bc">rows</a>; ++<a class="code" href="legacy_8hpp.html#a7be9b6436e5ea72ff5d5a66779b4bd38">k</a>) {
<a name="l00322"></a>00322             <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;dim_; ++i) {
<a name="l00323"></a>00323                 <span class="keywordflow">if</span> (dataset_[<a class="code" href="legacy_8hpp.html#a7be9b6436e5ea72ff5d5a66779b4bd38">k</a>][i]&lt;bbox[i].low) bbox[i].low = (<a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a>)dataset_[<a class="code" href="legacy_8hpp.html#a7be9b6436e5ea72ff5d5a66779b4bd38">k</a>][i];
<a name="l00324"></a>00324                 <span class="keywordflow">if</span> (dataset_[<a class="code" href="legacy_8hpp.html#a7be9b6436e5ea72ff5d5a66779b4bd38">k</a>][i]&gt;bbox[i].high) bbox[i].high = (<a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a>)dataset_[<a class="code" href="legacy_8hpp.html#a7be9b6436e5ea72ff5d5a66779b4bd38">k</a>][i];
<a name="l00325"></a>00325             }
<a name="l00326"></a>00326         }
<a name="l00327"></a>00327     }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 
<a name="l00339"></a>00339     NodePtr divideTree(<span class="keywordtype">int</span> left, <span class="keywordtype">int</span> <a class="code" href="calib3d_8hpp.html#a6b04b878081bf724144b73c75dfd1894">right</a>, BoundingBox&amp; bbox)
<a name="l00340"></a>00340     {
<a name="l00341"></a>00341         NodePtr <a class="code" href="core__c_8h.html#a4e145da43d8cadc65b69ce0c2a2cc76a">node</a> = pool_.<a class="code" href="classcvflann_1_1_pooled_allocator.html#aaf127cab57cd0e0f4d3b335efd8d3a67">allocate</a>&lt;Node&gt;(); <span class="comment">// allocate memory</span>
<a name="l00342"></a>00342 
<a name="l00343"></a>00343         <span class="comment">/* If too few exemplars remain, then make this a leaf node. */</span>
<a name="l00344"></a>00344         <span class="keywordflow">if</span> ( (right-left) &lt;= leaf_max_size_) {
<a name="l00345"></a>00345             node-&gt;child1 = node-&gt;child2 = NULL;    <span class="comment">/* Mark as leaf node. */</span>
<a name="l00346"></a>00346             node-&gt;left = left;
<a name="l00347"></a>00347             node-&gt;right = <a class="code" href="calib3d_8hpp.html#a6b04b878081bf724144b73c75dfd1894">right</a>;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349             <span class="comment">// compute bounding-box of leaf points</span>
<a name="l00350"></a>00350             <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;dim_; ++i) {
<a name="l00351"></a>00351                 bbox[i].low = (<a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a>)dataset_[vind_[left]][i];
<a name="l00352"></a>00352                 bbox[i].high = (<a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a>)dataset_[vind_[left]][i];
<a name="l00353"></a>00353             }
<a name="l00354"></a>00354             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="legacy_8hpp.html#a7be9b6436e5ea72ff5d5a66779b4bd38">k</a>=left+1; <a class="code" href="legacy_8hpp.html#a7be9b6436e5ea72ff5d5a66779b4bd38">k</a>&lt;<a class="code" href="calib3d_8hpp.html#a6b04b878081bf724144b73c75dfd1894">right</a>; ++<a class="code" href="legacy_8hpp.html#a7be9b6436e5ea72ff5d5a66779b4bd38">k</a>) {
<a name="l00355"></a>00355                 <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;dim_; ++i) {
<a name="l00356"></a>00356                     <span class="keywordflow">if</span> (bbox[i].low&gt;dataset_[vind_[<a class="code" href="legacy_8hpp.html#a7be9b6436e5ea72ff5d5a66779b4bd38">k</a>]][i]) bbox[i].low=(<a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a>)dataset_[vind_[<a class="code" href="legacy_8hpp.html#a7be9b6436e5ea72ff5d5a66779b4bd38">k</a>]][i];
<a name="l00357"></a>00357                     <span class="keywordflow">if</span> (bbox[i].high&lt;dataset_[vind_[<a class="code" href="legacy_8hpp.html#a7be9b6436e5ea72ff5d5a66779b4bd38">k</a>]][i]) bbox[i].high=(<a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a>)dataset_[vind_[<a class="code" href="legacy_8hpp.html#a7be9b6436e5ea72ff5d5a66779b4bd38">k</a>]][i];
<a name="l00358"></a>00358                 }
<a name="l00359"></a>00359             }
<a name="l00360"></a>00360         }
<a name="l00361"></a>00361         <span class="keywordflow">else</span> {
<a name="l00362"></a>00362             <span class="keywordtype">int</span> <a class="code" href="core__c_8h.html#a5c7c842f447336aa2f10826df65a28b3">idx</a>;
<a name="l00363"></a>00363             <span class="keywordtype">int</span> cutfeat;
<a name="l00364"></a>00364             <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> cutval;
<a name="l00365"></a>00365             middleSplit_(&amp;vind_[0]+left, right-left, idx, cutfeat, cutval, bbox);
<a name="l00366"></a>00366 
<a name="l00367"></a>00367             node-&gt;divfeat = cutfeat;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369             BoundingBox left_bbox(bbox);
<a name="l00370"></a>00370             left_bbox[cutfeat].high = cutval;
<a name="l00371"></a>00371             node-&gt;child1 = divideTree(left, left+idx, left_bbox);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373             BoundingBox right_bbox(bbox);
<a name="l00374"></a>00374             right_bbox[cutfeat].low = cutval;
<a name="l00375"></a>00375             node-&gt;child2 = divideTree(left+idx, right, right_bbox);
<a name="l00376"></a>00376 
<a name="l00377"></a>00377             node-&gt;divlow = left_bbox[cutfeat].high;
<a name="l00378"></a>00378             node-&gt;divhigh = right_bbox[cutfeat].low;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380             <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;dim_; ++i) {
<a name="l00381"></a>00381                 bbox[i].low = <a class="code" href="namespacecv.html#ab95fdcad3fb0246321e2af231d24d5a9" title="computes per-element minimum of two arrays (dst = min(src1, src2))">std::min</a>(left_bbox[i].low, right_bbox[i].low);
<a name="l00382"></a>00382                 bbox[i].high = <a class="code" href="namespacecv.html#a22a8f8afb6090a66a771348b658dcebd" title="computes per-element maximum of two arrays (dst = max(src1, src2))">std::max</a>(left_bbox[i].high, right_bbox[i].high);
<a name="l00383"></a>00383             }
<a name="l00384"></a>00384         }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386         <span class="keywordflow">return</span> <a class="code" href="core__c_8h.html#a4e145da43d8cadc65b69ce0c2a2cc76a">node</a>;
<a name="l00387"></a>00387     }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     <span class="keywordtype">void</span> computeMinMax(<span class="keywordtype">int</span>* ind, <span class="keywordtype">int</span> <a class="code" href="calib3d_8hpp.html#a88d78b1935cd8bdee70a44eaaf326b1e">count</a>, <span class="keywordtype">int</span> dim, <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">ElementType</a>&amp; min_elem, <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">ElementType</a>&amp; max_elem)
<a name="l00390"></a>00390     {
<a name="l00391"></a>00391         min_elem = dataset_[ind[0]][dim];
<a name="l00392"></a>00392         max_elem = dataset_[ind[0]][dim];
<a name="l00393"></a>00393         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i&lt;<a class="code" href="calib3d_8hpp.html#a88d78b1935cd8bdee70a44eaaf326b1e">count</a>; ++i) {
<a name="l00394"></a>00394             <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">ElementType</a> val = dataset_[ind[i]][dim];
<a name="l00395"></a>00395             <span class="keywordflow">if</span> (val&lt;min_elem) min_elem = val;
<a name="l00396"></a>00396             <span class="keywordflow">if</span> (val&gt;max_elem) max_elem = val;
<a name="l00397"></a>00397         }
<a name="l00398"></a>00398     }
<a name="l00399"></a>00399 
<a name="l00400"></a>00400     <span class="keywordtype">void</span> middleSplit(<span class="keywordtype">int</span>* ind, <span class="keywordtype">int</span> count, <span class="keywordtype">int</span>&amp; <a class="code" href="core__c_8h.html#a750b5d744c39a06bfb13e6eb010e35d0">index</a>, <span class="keywordtype">int</span>&amp; cutfeat, <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a>&amp; cutval, <span class="keyword">const</span> BoundingBox&amp; bbox)
<a name="l00401"></a>00401     {
<a name="l00402"></a>00402         <span class="comment">// find the largest span from the approximate bounding box</span>
<a name="l00403"></a>00403         <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">ElementType</a> max_span = bbox[0].high-bbox[0].low;
<a name="l00404"></a>00404         cutfeat = 0;
<a name="l00405"></a>00405         cutval = (bbox[0].high+bbox[0].low)/2;
<a name="l00406"></a>00406         <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=1; i&lt;dim_; ++i) {
<a name="l00407"></a>00407             <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">ElementType</a> span = bbox[i].high-bbox[i].low;
<a name="l00408"></a>00408             <span class="keywordflow">if</span> (span&gt;max_span) {
<a name="l00409"></a>00409                 max_span = span;
<a name="l00410"></a>00410                 cutfeat = i;
<a name="l00411"></a>00411                 cutval = (bbox[i].high+bbox[i].low)/2;
<a name="l00412"></a>00412             }
<a name="l00413"></a>00413         }
<a name="l00414"></a>00414 
<a name="l00415"></a>00415         <span class="comment">// compute exact span on the found dimension</span>
<a name="l00416"></a>00416         <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">ElementType</a> min_elem, max_elem;
<a name="l00417"></a>00417         computeMinMax(ind, count, cutfeat, min_elem, max_elem);
<a name="l00418"></a>00418         cutval = (min_elem+max_elem)/2;
<a name="l00419"></a>00419         max_span = max_elem - min_elem;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421         <span class="comment">// check if a dimension of a largest span exists</span>
<a name="l00422"></a>00422         <span class="keywordtype">size_t</span> <a class="code" href="legacy_8hpp.html#a7be9b6436e5ea72ff5d5a66779b4bd38">k</a> = cutfeat;
<a name="l00423"></a>00423         <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;dim_; ++i) {
<a name="l00424"></a>00424             <span class="keywordflow">if</span> (i==k) <span class="keywordflow">continue</span>;
<a name="l00425"></a>00425             <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">ElementType</a> span = bbox[i].high-bbox[i].low;
<a name="l00426"></a>00426             <span class="keywordflow">if</span> (span&gt;max_span) {
<a name="l00427"></a>00427                 computeMinMax(ind, count, i, min_elem, max_elem);
<a name="l00428"></a>00428                 span = max_elem - min_elem;
<a name="l00429"></a>00429                 <span class="keywordflow">if</span> (span&gt;max_span) {
<a name="l00430"></a>00430                     max_span = span;
<a name="l00431"></a>00431                     cutfeat = i;
<a name="l00432"></a>00432                     cutval = (min_elem+max_elem)/2;
<a name="l00433"></a>00433                 }
<a name="l00434"></a>00434             }
<a name="l00435"></a>00435         }
<a name="l00436"></a>00436         <span class="keywordtype">int</span> lim1, lim2;
<a name="l00437"></a>00437         planeSplit(ind, count, cutfeat, cutval, lim1, lim2);
<a name="l00438"></a>00438 
<a name="l00439"></a>00439         <span class="keywordflow">if</span> (lim1&gt;count/2) index = lim1;
<a name="l00440"></a>00440         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lim2&lt;count/2) index = lim2;
<a name="l00441"></a>00441         <span class="keywordflow">else</span> index = count/2;
<a name="l00442"></a>00442     }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 
<a name="l00445"></a>00445     <span class="keywordtype">void</span> middleSplit_(<span class="keywordtype">int</span>* ind, <span class="keywordtype">int</span> count, <span class="keywordtype">int</span>&amp; index, <span class="keywordtype">int</span>&amp; cutfeat, <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a>&amp; cutval, <span class="keyword">const</span> BoundingBox&amp; bbox)
<a name="l00446"></a>00446     {
<a name="l00447"></a>00447         <span class="keyword">const</span> <span class="keywordtype">float</span> EPS=0.00001f;
<a name="l00448"></a>00448         <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> max_span = bbox[0].high-bbox[0].low;
<a name="l00449"></a>00449         <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=1; i&lt;dim_; ++i) {
<a name="l00450"></a>00450             <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> span = bbox[i].high-bbox[i].low;
<a name="l00451"></a>00451             <span class="keywordflow">if</span> (span&gt;max_span) {
<a name="l00452"></a>00452                 max_span = span;
<a name="l00453"></a>00453             }
<a name="l00454"></a>00454         }
<a name="l00455"></a>00455         <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> max_spread = -1;
<a name="l00456"></a>00456         cutfeat = 0;
<a name="l00457"></a>00457         <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;dim_; ++i) {
<a name="l00458"></a>00458             <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> span = bbox[i].high-bbox[i].low;
<a name="l00459"></a>00459             <span class="keywordflow">if</span> (span&gt;(<a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a>)((1-EPS)*max_span)) {
<a name="l00460"></a>00460                 <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">ElementType</a> min_elem, max_elem;
<a name="l00461"></a>00461                 computeMinMax(ind, count, cutfeat, min_elem, max_elem);
<a name="l00462"></a>00462                 <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> spread = (<a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a>)(max_elem-min_elem);
<a name="l00463"></a>00463                 <span class="keywordflow">if</span> (spread&gt;max_spread) {
<a name="l00464"></a>00464                     cutfeat = (<a class="code" href="namespacecv_1_1gpu_1_1device.html#a75abe072f62e9cbacd4e282107467bbb">int</a>)i;
<a name="l00465"></a>00465                     max_spread = spread;
<a name="l00466"></a>00466                 }
<a name="l00467"></a>00467             }
<a name="l00468"></a>00468         }
<a name="l00469"></a>00469         <span class="comment">// split in the middle</span>
<a name="l00470"></a>00470         <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> split_val = (bbox[cutfeat].low+bbox[cutfeat].high)/2;
<a name="l00471"></a>00471         <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">ElementType</a> min_elem, max_elem;
<a name="l00472"></a>00472         computeMinMax(ind, count, cutfeat, min_elem, max_elem);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474         <span class="keywordflow">if</span> (split_val&lt;min_elem) cutval = (<a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a>)min_elem;
<a name="l00475"></a>00475         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (split_val&gt;max_elem) cutval = (<a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a>)max_elem;
<a name="l00476"></a>00476         <span class="keywordflow">else</span> cutval = split_val;
<a name="l00477"></a>00477 
<a name="l00478"></a>00478         <span class="keywordtype">int</span> lim1, lim2;
<a name="l00479"></a>00479         planeSplit(ind, count, cutfeat, cutval, lim1, lim2);
<a name="l00480"></a>00480 
<a name="l00481"></a>00481         <span class="keywordflow">if</span> (lim1&gt;count/2) index = lim1;
<a name="l00482"></a>00482         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lim2&lt;count/2) index = lim2;
<a name="l00483"></a>00483         <span class="keywordflow">else</span> index = count/2;
<a name="l00484"></a>00484     }
<a name="l00485"></a>00485 
<a name="l00486"></a>00486 
<a name="l00496"></a>00496     <span class="keywordtype">void</span> planeSplit(<span class="keywordtype">int</span>* ind, <span class="keywordtype">int</span> count, <span class="keywordtype">int</span> cutfeat, <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> cutval, <span class="keywordtype">int</span>&amp; lim1, <span class="keywordtype">int</span>&amp; lim2)
<a name="l00497"></a>00497     {
<a name="l00498"></a>00498         <span class="comment">/* Move vector indices for left subtree to front of list. */</span>
<a name="l00499"></a>00499         <span class="keywordtype">int</span> left = 0;
<a name="l00500"></a>00500         <span class="keywordtype">int</span> right = count-1;
<a name="l00501"></a>00501         <span class="keywordflow">for</span> (;; ) {
<a name="l00502"></a>00502             <span class="keywordflow">while</span> (left&lt;=right &amp;&amp; dataset_[ind[left]][cutfeat]&lt;cutval) ++left;
<a name="l00503"></a>00503             <span class="keywordflow">while</span> (left&lt;=right &amp;&amp; dataset_[ind[right]][cutfeat]&gt;=cutval) --<a class="code" href="calib3d_8hpp.html#a6b04b878081bf724144b73c75dfd1894">right</a>;
<a name="l00504"></a>00504             <span class="keywordflow">if</span> (left&gt;right) <span class="keywordflow">break</span>;
<a name="l00505"></a>00505             <a class="code" href="namespacecv.html#aee66fd35ceb08e5e93177b123481a25e" title="swaps two matrices">std::swap</a>(ind[left], ind[right]); ++left; --<a class="code" href="calib3d_8hpp.html#a6b04b878081bf724144b73c75dfd1894">right</a>;
<a name="l00506"></a>00506         }
<a name="l00507"></a>00507         <span class="comment">/* If either list is empty, it means that all remaining features</span>
<a name="l00508"></a>00508 <span class="comment">         * are identical. Split in the middle to maintain a balanced tree.</span>
<a name="l00509"></a>00509 <span class="comment">         */</span>
<a name="l00510"></a>00510         lim1 = left;
<a name="l00511"></a>00511         right = count-1;
<a name="l00512"></a>00512         <span class="keywordflow">for</span> (;; ) {
<a name="l00513"></a>00513             <span class="keywordflow">while</span> (left&lt;=right &amp;&amp; dataset_[ind[left]][cutfeat]&lt;=cutval) ++left;
<a name="l00514"></a>00514             <span class="keywordflow">while</span> (left&lt;=right &amp;&amp; dataset_[ind[right]][cutfeat]&gt;cutval) --<a class="code" href="calib3d_8hpp.html#a6b04b878081bf724144b73c75dfd1894">right</a>;
<a name="l00515"></a>00515             <span class="keywordflow">if</span> (left&gt;right) <span class="keywordflow">break</span>;
<a name="l00516"></a>00516             <a class="code" href="namespacecv.html#aee66fd35ceb08e5e93177b123481a25e" title="swaps two matrices">std::swap</a>(ind[left], ind[right]); ++left; --<a class="code" href="calib3d_8hpp.html#a6b04b878081bf724144b73c75dfd1894">right</a>;
<a name="l00517"></a>00517         }
<a name="l00518"></a>00518         lim2 = left;
<a name="l00519"></a>00519     }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> computeInitialDistances(<span class="keyword">const</span> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">ElementType</a>* vec, std::vector&lt;DistanceType&gt;&amp; dists)
<a name="l00522"></a>00522     {
<a name="l00523"></a>00523         <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> distsq = 0.0;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525         <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; dim_; ++i) {
<a name="l00526"></a>00526             <span class="keywordflow">if</span> (vec[i] &lt; root_bbox_[i].low) {
<a name="l00527"></a>00527                 dists[i] = distance_.accum_dist(vec[i], root_bbox_[i].low, (<span class="keywordtype">int</span>)i);
<a name="l00528"></a>00528                 distsq += dists[i];
<a name="l00529"></a>00529             }
<a name="l00530"></a>00530             <span class="keywordflow">if</span> (vec[i] &gt; root_bbox_[i].high) {
<a name="l00531"></a>00531                 dists[i] = distance_.accum_dist(vec[i], root_bbox_[i].high, (<span class="keywordtype">int</span>)i);
<a name="l00532"></a>00532                 distsq += dists[i];
<a name="l00533"></a>00533             }
<a name="l00534"></a>00534         }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536         <span class="keywordflow">return</span> distsq;
<a name="l00537"></a>00537     }
<a name="l00538"></a>00538 
<a name="l00542"></a>00542     <span class="keywordtype">void</span> searchLevel(ResultSet&lt;DistanceType&gt;&amp; result_set, <span class="keyword">const</span> <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">ElementType</a>* vec, <span class="keyword">const</span> NodePtr node, <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> mindistsq,
<a name="l00543"></a>00543                      std::vector&lt;DistanceType&gt;&amp; dists, <span class="keyword">const</span> <span class="keywordtype">float</span> epsError)
<a name="l00544"></a>00544     {
<a name="l00545"></a>00545         <span class="comment">/* If this is a leaf node, then do check and return. */</span>
<a name="l00546"></a>00546         <span class="keywordflow">if</span> ((node-&gt;child1 == NULL)&amp;&amp;(node-&gt;child2 == NULL)) {
<a name="l00547"></a>00547             <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> worst_dist = result_set.worstDist();
<a name="l00548"></a>00548             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=node-&gt;left; i&lt;node-&gt;right; ++i) {
<a name="l00549"></a>00549                 <span class="keywordtype">int</span> index = reorder_ ? i : vind_[i];
<a name="l00550"></a>00550                 <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> <a class="code" href="legacy_8hpp.html#ae895c2003a87eda49126845b7ac3688e">dist</a> = distance_(vec, data_[index], dim_, worst_dist);
<a name="l00551"></a>00551                 <span class="keywordflow">if</span> (dist&lt;worst_dist) {
<a name="l00552"></a>00552                     result_set.addPoint(dist,vind_[i]);
<a name="l00553"></a>00553                 }
<a name="l00554"></a>00554             }
<a name="l00555"></a>00555             <span class="keywordflow">return</span>;
<a name="l00556"></a>00556         }
<a name="l00557"></a>00557 
<a name="l00558"></a>00558         <span class="comment">/* Which child branch should be taken first? */</span>
<a name="l00559"></a>00559         <span class="keywordtype">int</span> <a class="code" href="core__c_8h.html#a5c7c842f447336aa2f10826df65a28b3">idx</a> = node-&gt;divfeat;
<a name="l00560"></a>00560         <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#a3b7bf5e05057a76d1b7eee693062784e">ElementType</a> val = vec[<a class="code" href="core__c_8h.html#a5c7c842f447336aa2f10826df65a28b3">idx</a>];
<a name="l00561"></a>00561         <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> diff1 = val - node-&gt;divlow;
<a name="l00562"></a>00562         <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> diff2 = val - node-&gt;divhigh;
<a name="l00563"></a>00563 
<a name="l00564"></a>00564         NodePtr bestChild;
<a name="l00565"></a>00565         NodePtr otherChild;
<a name="l00566"></a>00566         <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> cut_dist;
<a name="l00567"></a>00567         <span class="keywordflow">if</span> ((diff1+diff2)&lt;0) {
<a name="l00568"></a>00568             bestChild = node-&gt;child1;
<a name="l00569"></a>00569             otherChild = node-&gt;child2;
<a name="l00570"></a>00570             cut_dist = distance_.accum_dist(val, node-&gt;divhigh, idx);
<a name="l00571"></a>00571         }
<a name="l00572"></a>00572         <span class="keywordflow">else</span> {
<a name="l00573"></a>00573             bestChild = node-&gt;child2;
<a name="l00574"></a>00574             otherChild = node-&gt;child1;
<a name="l00575"></a>00575             cut_dist = distance_.accum_dist( val, node-&gt;divlow, idx);
<a name="l00576"></a>00576         }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578         <span class="comment">/* Call recursively to search next level down. */</span>
<a name="l00579"></a>00579         searchLevel(result_set, vec, bestChild, mindistsq, dists, epsError);
<a name="l00580"></a>00580 
<a name="l00581"></a>00581         <a class="code" href="classcvflann_1_1_k_d_tree_single_index.html#ab32f2e8496ef780c2538576b8a330029">DistanceType</a> <a class="code" href="calib3d_8hpp.html#ad07a04090e384b855c78ca9fb981b7a8">dst</a> = dists[<a class="code" href="core__c_8h.html#a5c7c842f447336aa2f10826df65a28b3">idx</a>];
<a name="l00582"></a>00582         mindistsq = mindistsq + cut_dist - <a class="code" href="calib3d_8hpp.html#ad07a04090e384b855c78ca9fb981b7a8">dst</a>;
<a name="l00583"></a>00583         dists[<a class="code" href="core__c_8h.html#a5c7c842f447336aa2f10826df65a28b3">idx</a>] = cut_dist;
<a name="l00584"></a>00584         <span class="keywordflow">if</span> (mindistsq*epsError&lt;=result_set.worstDist()) {
<a name="l00585"></a>00585             searchLevel(result_set, vec, otherChild, mindistsq, dists, epsError);
<a name="l00586"></a>00586         }
<a name="l00587"></a>00587         dists[<a class="code" href="core__c_8h.html#a5c7c842f447336aa2f10826df65a28b3">idx</a>] = <a class="code" href="calib3d_8hpp.html#ad07a04090e384b855c78ca9fb981b7a8">dst</a>;
<a name="l00588"></a>00588     }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 <span class="keyword">private</span>:
<a name="l00591"></a>00591 
<a name="l00595"></a>00595     <span class="keyword">const</span> Matrix&lt;ElementType&gt; dataset_;
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     <a class="code" href="namespacecvflann.html#a742b4c7076c21012054af74a9ee48289">IndexParams</a> index_params_;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     <span class="keywordtype">int</span> leaf_max_size_;
<a name="l00600"></a>00600     <span class="keywordtype">bool</span> reorder_;
<a name="l00601"></a>00601 
<a name="l00602"></a>00602 
<a name="l00606"></a>00606     std::vector&lt;int&gt; vind_;
<a name="l00607"></a>00607 
<a name="l00608"></a>00608     Matrix&lt;ElementType&gt; data_;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     <span class="keywordtype">size_t</span> size_;
<a name="l00611"></a>00611     <span class="keywordtype">size_t</span> dim_;
<a name="l00612"></a>00612 
<a name="l00616"></a>00616     NodePtr root_node_;
<a name="l00617"></a>00617 
<a name="l00618"></a>00618     BoundingBox root_bbox_;
<a name="l00619"></a>00619 
<a name="l00627"></a>00627     PooledAllocator pool_;
<a name="l00628"></a>00628 
<a name="l00629"></a>00629     Distance distance_;
<a name="l00630"></a>00630 };   <span class="comment">// class KDTree</span>
<a name="l00631"></a>00631 
<a name="l00632"></a>00632 }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634 <span class="preprocessor">#endif //OPENCV_FLANN_KDTREE_SINGLE_INDEX_H_</span>
</pre></div></div><!-- contents -->
	<div class="footer">
		<p> </p>
	</div>
</div>	
</body>
</html>
